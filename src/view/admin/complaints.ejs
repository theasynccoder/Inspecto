<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Complaints Management - Inspecto</title>
  <link rel="stylesheet" href="/css/adminDashboard.css">
  <style>
    .sentiment-dashboard {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin: 20px 0;
    }

    .stat-card {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .stat-card h3 {
      margin: 0 0 10px 0;
      color: #666;
      font-size: 14px;
      font-weight: normal;
    }

    .stat-card .value {
      font-size: 32px;
      font-weight: bold;
      color: #333;
    }

    .sentiment-breakdown {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }

    .sentiment-item {
      flex: 1;
      text-align: center;
      padding: 10px;
      border-radius: 4px;
      background: #f5f5f5;
    }

    .sentiment-item.positive { background: #d4edda; color: #155724; }
    .sentiment-item.neutral { background: #fff3cd; color: #856404; }
    .sentiment-item.negative { background: #f8d7da; color: #721c24; }

    .urgency-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: bold;
      text-transform: uppercase;
    }

    .urgency-critical { background: #dc3545; color: white; }
    .urgency-high { background: #fd7e14; color: white; }
    .urgency-medium { background: #ffc107; color: #333; }
    .urgency-low { background: #28a745; color: white; }

    .sentiment-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: bold;
    }

    .sentiment-negative { background: #f8d7da; color: #721c24; }
    .sentiment-neutral { background: #fff3cd; color: #856404; }
    .sentiment-positive { background: #d4edda; color: #155724; }

    .filters {
      background: white;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: flex;
      gap: 20px;
      align-items: center;
    }

    .filters select {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }

    .complaints-table {
      background: white;
      border-radius: 8px;
      overflow: hidden;
    }

    .complaints-table table {
      width: 100%;
      border-collapse: collapse;
    }

    .complaints-table th {
      background: #f8f9fa;
      padding: 12px;
      text-align: left;
      font-weight: 600;
      border-bottom: 2px solid #dee2e6;
    }

    .complaints-table td {
      padding: 12px;
      border-bottom: 1px solid #dee2e6;
    }

    .complaints-table tr:hover {
      background: #f8f9fa;
    }

    .key-issues {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      margin-top: 5px;
    }

    .key-issue-tag {
      background: #e9ecef;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 11px;
      color: #495057;
    }

    .status-select {
      padding: 4px 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 12px;
    }

    .top-issues {
      background: white;
      padding: 20px;
      border-radius: 8px;
      margin-top: 20px;
    }

    .issue-bar {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }

    .issue-name {
      width: 150px;
      font-size: 14px;
    }

    .issue-chart {
      flex: 1;
      height: 20px;
      background: #e9ecef;
      border-radius: 10px;
      overflow: hidden;
      margin: 0 10px;
    }

    .issue-fill {
      height: 100%;
      background: linear-gradient(90deg, #007bff, #0056b3);
    }

    .issue-count {
      width: 40px;
      text-align: right;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <%- include('../partials/header3') %>
  
  <div class="container">
    <h1>Complaints Management with AI Sentiment Analysis</h1>
    <p style="color: #666; margin-bottom: 20px;">Zone: <strong><%= zone %></strong></p>

    <!-- Sentiment Statistics Dashboard -->
    <div class="sentiment-dashboard">
      <div class="stat-card">
        <h3>Total Complaints</h3>
        <div class="value"><%= sentimentStats.total %></div>
      </div>
      
      <div class="stat-card">
        <h3>Average Sentiment Score</h3>
        <div class="value"><%= sentimentStats.avg_sentiment_score %></div>
        <div class="sentiment-breakdown">
          <div class="sentiment-item positive">
            <div><%= sentimentStats.sentiment.positive %></div>
            <small>Positive</small>
          </div>
          <div class="sentiment-item neutral">
            <div><%= sentimentStats.sentiment.neutral %></div>
            <small>Neutral</small>
          </div>
          <div class="sentiment-item negative">
            <div><%= sentimentStats.sentiment.negative %></div>
            <small>Negative</small>
          </div>
        </div>
      </div>

      <div class="stat-card">
        <h3>By Urgency Level</h3>
        <div style="margin-top: 10px;">
          <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
            <span>ðŸ”´ Critical:</span> <strong><%= sentimentStats.urgency.critical || 0 %></strong>
          </div>
          <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
            <span>ðŸŸ  High:</span> <strong><%= sentimentStats.urgency.high || 0 %></strong>
          </div>
          <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
            <span>ðŸŸ¡ Medium:</span> <strong><%= sentimentStats.urgency.medium || 0 %></strong>
          </div>
          <div style="display: flex; justify-content: space-between;">
            <span>ðŸŸ¢ Low:</span> <strong><%= sentimentStats.urgency.low || 0 %></strong>
          </div>
        </div>
      </div>
    </div>

    <!-- Filters -->
    <div class="filters">
      <label>
        <strong>Filter by Urgency:</strong>
        <select id="urgencyFilter" onchange="applyFilters()">
          <option value="all" <%= filterUrgency === 'all' ? 'selected' : '' %>>All</option>
          <option value="critical" <%= filterUrgency === 'critical' ? 'selected' : '' %>>Critical</option>
          <option value="high" <%= filterUrgency === 'high' ? 'selected' : '' %>>High</option>
          <option value="medium" <%= filterUrgency === 'medium' ? 'selected' : '' %>>Medium</option>
          <option value="low" <%= filterUrgency === 'low' ? 'selected' : '' %>>Low</option>
        </select>
      </label>

      <label>
        <strong>Filter by Sentiment:</strong>
        <select id="sentimentFilter" onchange="applyFilters()">
          <option value="all" <%= filterSentiment === 'all' ? 'selected' : '' %>>All</option>
          <option value="negative" <%= filterSentiment === 'negative' ? 'selected' : '' %>>Negative</option>
          <option value="neutral" <%= filterSentiment === 'neutral' ? 'selected' : '' %>>Neutral</option>
          <option value="positive" <%= filterSentiment === 'positive' ? 'selected' : '' %>>Positive</option>
        </select>
      </label>
    </div>

    <!-- Complaints Table -->
    <div class="complaints-table">
      <table>
        <thead>
          <tr>
            <th>Date</th>
            <th>Restaurant</th>
            <th>Subject</th>
            <th>Urgency</th>
            <th>Sentiment</th>
            <th>Key Issues</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <% complaints.forEach(complaint => { %>
            <tr>
              <td><%= new Date(complaint.created_at).toLocaleDateString() %></td>
              <td><%= complaint.restaurant_name %></td>
              <td>
                <strong><%= complaint.subject %></strong>
                <br>
                <small style="color: #666;"><%= complaint.message.substring(0, 80) %>...</small>
              </td>
              <td>
                <span class="urgency-badge urgency-<%= complaint.urgency || 'medium' %>">
                  <%= complaint.urgency || 'medium' %>
                </span>
              </td>
              <td>
                <span class="sentiment-badge sentiment-<%= complaint.sentiment || 'neutral' %>">
                  <%= complaint.sentiment || 'neutral' %>
                </span>
                <br>
                <small>Score: <%= complaint.sentiment_score ? Number(complaint.sentiment_score).toFixed(2) : 'N/A' %></small>
              </td>
              <td>
                <div class="key-issues">
                  <% if (complaint.ai_analysis && complaint.ai_analysis.key_issues) { %>
                    <% complaint.ai_analysis.key_issues.slice(0, 3).forEach(issue => { %>
                      <span class="key-issue-tag"><%= issue %></span>
                    <% }); %>
                  <% } %>
                </div>
              </td>
              <td>
                <span style="text-transform: capitalize; color: <%= 
                  complaint.status === 'resolved' ? '#28a745' : 
                  complaint.status === 'in-progress' ? '#ffc107' : '#6c757d' 
                %>">
                  <%= complaint.status %>
                </span>
              </td>
              <td>
                <form method="POST" action="/admin/complaints/<%= complaint.id %>/status" style="display: inline;">
                  <select name="status" class="status-select" onchange="this.form.submit()">
                    <option value="pending" <%= complaint.status === 'pending' ? 'selected' : '' %>>Pending</option>
                    <option value="in-progress" <%= complaint.status === 'in-progress' ? 'selected' : '' %>>In Progress</option>
                    <option value="resolved" <%= complaint.status === 'resolved' ? 'selected' : '' %>>Resolved</option>
                    <option value="rejected" <%= complaint.status === 'rejected' ? 'selected' : '' %>>Rejected</option>
                  </select>
                </form>
              </td>
            </tr>
          <% }); %>
        </tbody>
      </table>

      <% if (complaints.length === 0) { %>
        <div style="padding: 40px; text-align: center; color: #666;">
          No complaints found matching your filters.
        </div>
      <% } %>
    </div>

    <!-- Top Issues -->
    <% if (sentimentStats.top_issues && sentimentStats.top_issues.length > 0) { %>
      <div class="top-issues">
        <h2>Top Issues Identified</h2>
        <% const maxCount = sentimentStats.top_issues[0].count; %>
        <% sentimentStats.top_issues.forEach(item => { %>
          <div class="issue-bar">
            <div class="issue-name"><%= item.issue %></div>
            <div class="issue-chart">
              <div class="issue-fill" style="width: <%= (item.count / maxCount * 100) %>%"></div>
            </div>
            <div class="issue-count"><%= item.count %></div>
          </div>
        <% }); %>
      </div>
    <% } %>
  </div>

  <script>
    function applyFilters() {
      const urgency = document.getElementById('urgencyFilter').value;
      const sentiment = document.getElementById('sentimentFilter').value;
      window.location.href = `/admin/complaints?urgency=${urgency}&sentiment=${sentiment}`;
    }
  </script>
</body>
</html>
