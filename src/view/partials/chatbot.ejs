<!-- ‚úÖ CHATBOT STYLES -->
<style>
  /* Chatbot */
  #food-chatbot-btn {
    position: fixed;
    bottom: 32px;
    right: 32px;
    z-index: 9999;
  }

  #food-chatbot-btn button {
    width: 70px;
    height: 70px;
    border-radius: 50%;
    background: linear-gradient(135deg, #14b8a6 0%, #0d9488 100%);
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 10px 40px rgba(20, 184, 166, 0.4);
    transition: all 0.3s ease;
    animation: pulse 2s infinite;
  }

  @keyframes pulse {
    0%, 100% { box-shadow: 0 10px 40px rgba(20, 184, 166, 0.4); }
    50% { box-shadow: 0 10px 60px rgba(20, 184, 166, 0.6); }
  }

  #food-chatbot-btn button:hover {
    transform: scale(1.1);
  }

  #food-chatbot-btn img {
    width: 40px;
    height: 40px;
  }

  #food-chatbot-popup {
    display: none;
    position: fixed;
    bottom: 120px;
    right: 32px;
    width: 380px;
    max-width: 90vw;
    height: 500px;
    max-height: 80vh;
    border-radius: 24px;
    box-shadow: 0 25px 50px rgba(0,0,0,0.3);
    z-index: 10000;
    overflow: hidden;
    flex-direction: column;
    background: #0f172a;
    border: 1px solid rgba(255,255,255,0.1);
  }

  #food-chatbot-popup .chatbot-header {
    padding: 20px 24px;
    font-weight: 600;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 1.1rem;
    background: linear-gradient(135deg, #14b8a6 0%, #0d9488 100%);
    color: white;
  }

  #close-chatbot {
    cursor: pointer;
    font-size: 24px;
    opacity: 0.7;
    transition: opacity 0.3s;
  }

  #close-chatbot:hover {
    opacity: 1;
  }

  #chatbot-messages {
    flex: 1;
    padding: 20px;
    overflow-y: auto;
    font-size: 15px;
    background: #1e293b;
  }

  .msg-user {
    margin: 10px 0;
    padding: 10px 12px;
    border-radius: 14px;
    max-width: 80%;
    background: #14b8a6;
    color: white;
    align-self: flex-end;
    margin-left: auto;
    white-space: pre-wrap;
  }

  .msg-bot {
    margin: 10px 0;
    padding: 10px 12px;
    border-radius: 14px;
    max-width: 80%;
    background: rgba(255,255,255,0.08);
    color: white;
    align-self: flex-start;
    white-space: pre-wrap;
  }

  .chatbot-input-area {
    padding: 16px 20px;
    border-top: 1px solid rgba(255,255,255,0.1);
    display: flex;
    gap: 12px;
    background: #0f172a;
  }

  #chatbot-input {
    flex: 1;
    padding: 14px 18px;
    border-radius: 50px;
    font-size: 0.95rem;
    background: #0f172a;
    border: 1px solid rgba(255,255,255,0.1);
    color: white;
    outline: none;
  }

  #send-chatbot {
    background: linear-gradient(135deg, #14b8a6 0%, #0d9488 100%);
    color: #fff;
    padding: 14px 24px;
    border: none;
    border-radius: 50px;
    cursor: pointer;
    font-weight: 600;
  }
</style>

<!-- ‚úÖ CHATBOT HTML -->
<div id="food-chatbot-btn">
  <button id="open-chatbot-btn">
    <img src="/chatbot/images/chatbot.png" alt="Chatbot" />
  </button>
</div>

<div id="food-chatbot-popup">
  <div class="chatbot-header">
    <span>üçΩÔ∏è Food Hygiene Assistant</span>
    <span id="close-chatbot">&times;</span>
  </div>

  <div id="chatbot-messages"></div>

  <div class="chatbot-input-area">
    <input id="chatbot-input" type="text" placeholder="Ask about food inspections..." />
    <button id="send-chatbot">Send</button>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<!-- ‚úÖ CHATBOT JS -->
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const openBtn = document.getElementById("open-chatbot-btn");
    const popup = document.getElementById("food-chatbot-popup");
    const closeBtn = document.getElementById("close-chatbot");

    const sendBtn = document.getElementById("send-chatbot");
    const input = document.getElementById("chatbot-input");
    const messages = document.getElementById("chatbot-messages");

    openBtn?.addEventListener("click", () => {
      popup.style.display = "flex";
    });

    closeBtn?.addEventListener("click", () => {
      popup.style.display = "none";
    });

    function appendMessage(text, who) {
      const div = document.createElement("div");
      div.className = who === "user" ? "msg-user" : "msg-bot";

      if (who === "bot") {
        div.innerHTML = marked.parse(text);
      } else {
        div.textContent = text;
      }

      messages.appendChild(div);
      messages.scrollTop = messages.scrollHeight;
      return div;
    }

    // ‚úÖ create loading bubble
    function appendLoading() {
      const div = document.createElement("div");
      div.className = "msg-bot";
      div.innerHTML = `
        <div style="display:flex;flex-direction:column;gap:8px;">
          <div><b>ü§ñ Assistant:</b> <span id="step-text">Processing...</span></div>
          <div style="display:flex;gap:6px;">
            <span class="dot"></span>
            <span class="dot"></span>
            <span class="dot"></span>
          </div>
        </div>
      `;
      messages.appendChild(div);
      messages.scrollTop = messages.scrollHeight;
      return div;
    }

    // ‚úÖ update loading steps
    function updateStep(loadingDiv, text) {
      const step = loadingDiv.querySelector("#step-text");
      if (step) step.textContent = text;
    }

    async function sendMessage() {
      const userText = input.value.trim();
      if (!userText) return;

      appendMessage(userText, "user");
      input.value = "";

      // ‚úÖ disable input while processing
      sendBtn.disabled = true;
      input.disabled = true;

      // ‚úÖ show loading bubble
      const loadingDiv = appendLoading();

      try {
        // ‚úÖ show steps while waiting
        updateStep(loadingDiv, "üîç Extracting restaurant name...");
        await new Promise(r => setTimeout(r, 600));

        updateStep(loadingDiv, "üì¶ Searching database context...");
        await new Promise(r => setTimeout(r, 700));

        updateStep(loadingDiv, "ü§ñ Generating Gemini response...");
        
        const res = await fetch("/food-chatbot", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ prompt: userText })
        });

        const data = await res.json();

        // ‚úÖ remove loading
        loadingDiv.remove();

        appendMessage(data.response || "No response from bot.", "bot");

      } catch (err) {
        loadingDiv.remove();
        appendMessage("‚ö†Ô∏è Server error: Unable to reach chatbot.", "bot");
      } finally {
        // ‚úÖ enable back
        sendBtn.disabled = false;
        input.disabled = false;
        input.focus();
      }
    }

    sendBtn?.addEventListener("click", sendMessage);

    input?.addEventListener("keypress", (e) => {
      if (e.key === "Enter") sendMessage();
    });
  });
</script>
